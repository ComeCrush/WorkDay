<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.heima.travel.mapper.RouteMapper">

    <!--最受欢迎-->
    <select id="getPopularRoutes" resultType="route">
        select * from tab_route where rflag=1 order by count desc
    </select>

    <select id="getNewRoutes" resultType="route">
        select * from tab_route where rflag=1 order by rdate desc
    </select>

    <select id="getThemeRoutes" resultType="route">
        select * from tab_route where rflag=1 and isThemeTour=1 order by rdate
    </select>

    <select id="findRoutesByCategoryIdAndRouteName" resultType="route">
        select * from tab_route
         <where>
             <if test="cid!=null">
                 cid=#{cid}
             </if>
             <if test="rname!=null and rname!=''">
                 and rname like concat('%',#{rname},'%')
             </if>
         </where>
    </select>

    <resultMap id="routeMap" type="route" autoMapping="true">
        <!--route部分封装-->
        <id column="rid" property="rid"/>
        <result column="rname" property="rname"/>
        <result column="price" property="price"/>
        <result column="routeIntroduce" property="routeIntroduce"/>
        <result column="rflag" property="rflag"/>
        <result column="rdate" property="rdate"/>
        <result column="isThemeTour" property="isThemeTour"/>
        <result column="count" property="count"/>
        <result column="cid" property="cid"/>
        <result column="sid" property="sid"/>
        <result column="rimage" property="rimage"/>
        <result column="sourceId" property="sourceId"/>
        <!--卖家信息映射-->
        <association property="seller" javaType="seller" autoMapping="true">
            <id column="sid" property="sid"/>
            <result column="sname" property="sname"/>
            <result column="consphone" property="consphone"/>
            <result column="address" property="address"/>
        </association>
        <!--映射分类信息-->
        <association property="category" javaType="category" autoMapping="true">
            <id column="cid" property="cid"/>
            <result column="cname" property="cname"/>
        </association>
        <!--映射集合-->
        <collection property="routeImgList" javaType="list" ofType="routeImg">
            <id column="rgid" property="rgid"/>
            <result column="rid" property="rid"/>
            <result column="bigPic" property="bigPic"/>
            <result column="smallPic" property="smallPic"/>
        </collection>
    </resultMap>
    <select id="findRouteInfoByRid" resultMap="routeMap">
        select * from
          tab_route as ro,
          tab_seller as se,
          tab_category as ca,
          tab_route_img as roi
        where
            ro.sid = se.sid
            and ro.cid = ca.cid
            and ro.rid = roi.rid
            and ro.rid = #{rid}
    </select>

    <update id="updateRouteFavoriteCount">
        update tab_route set count=count+#{incNum} where rid=#{routId}
    </update>

    <select id="findRoutesFavoriteRank" resultType="route">
        select * from tab_route
        <where>
            <if test="rname!=null">
                rname like concat('%',#{rname},'%')
            </if>
            <if test="startPrice!=null">
                and price > #{startPrice}
            </if>
            <if test="endPrice!=null">
                and price $lt #{endPrice}
            </if>
            order by count desc
        </where>
    </select>


</mapper>